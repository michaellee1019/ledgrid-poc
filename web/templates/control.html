{% extends "base.html" %}

{% block title %}Animation Control Panel{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h2><i class="fas fa-sliders-h"></i> Animation Control Panel</h2>
        <style>
            .dpad {
                display: grid;
                grid-template-columns: repeat(3, 56px);
                grid-template-rows: repeat(3, 56px);
                gap: 10px;
                justify-content: center;
                align-items: center;
            }

            .dpad-btn {
                font-size: 1.5rem;
                border: 1px solid #dee2e6;
                background: #f8f9fa;
                border-radius: 12px;
                height: 56px;
                width: 56px;
                line-height: 1;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                transition: transform 0.05s ease, box-shadow 0.05s ease;
            }

            .dpad-btn:active {
                transform: translateY(1px);
                box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.15);
            }

            .dpad-spacer {
                height: 56px;
                width: 56px;
            }

            @media (max-width: 575.98px) {
                .dpad {
                    grid-template-columns: repeat(3, 48px);
                    grid-template-rows: repeat(3, 48px);
                    gap: 8px;
                }

                .dpad-btn,
                .dpad-spacer {
                    height: 48px;
                    width: 48px;
                }
            }
        </style>
        
        <div class="card">
            <div class="card-header">
                <h5>Select Animation</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for animation in animations %}
                    <div class="col-md-6 mb-2">
                        <button class="btn btn-outline-primary w-100 animation-btn" 
                                data-animation="{{ animation.plugin_name }}"
                                onclick="selectAnimation('{{ animation.plugin_name }}')">
                            {{ animation.name }}
                        </button>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-danger" onclick="stopAnimation()" id="stopBtn">
                        <i class="fas fa-stop"></i> Stop Animation
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card mt-3" id="parametersCard" style="display: none;">
            <div class="card-header">
                <h5>Animation Parameters</h5>
                <small class="text-muted">Adjust parameters in real-time</small>
            </div>
            <div class="card-body" id="parametersContainer">
                <!-- Parameters will be loaded here -->
            </div>
        </div>

        <div class="card mt-3" id="tetrisControlsCard" style="display: none;">
            <div class="card-header">
                <h5>üéÆ Tetris D-Pad</h5>
                <small class="text-muted">Use ‚¨ÜÔ∏è to rotate, ‚¨ÖÔ∏è/‚û°Ô∏è to move, ‚¨áÔ∏è to soft drop.</small>
            </div>
            <div class="card-body">
                <div class="dpad" aria-label="Tetris D-pad">
                    <div class="dpad-spacer"></div>
                    <button class="dpad-btn" data-direction="up" aria-label="Rotate">‚¨ÜÔ∏è</button>
                    <div class="dpad-spacer"></div>
                    <button class="dpad-btn" data-direction="left" aria-label="Move left">‚¨ÖÔ∏è</button>
                    <div class="dpad-spacer"></div>
                    <button class="dpad-btn" data-direction="right" aria-label="Move right">‚û°Ô∏è</button>
                    <div class="dpad-spacer"></div>
                    <button class="dpad-btn" data-direction="down" aria-label="Soft drop">‚¨áÔ∏è</button>
                    <div class="dpad-spacer"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Current Status</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Animation:</strong><br>
                    <span class="status-indicator {{ 'status-running' if status.is_running else 'status-stopped' }}"></span>
                    <span class="status-text">
                        {% if status.is_running %}
                            {{ status.current_animation }}
                        {% else %}
                            None
                        {% endif %}
                    </span>
                </div>
                
                <div class="mb-3">
                    <strong>Performance:</strong><br>
                    <span class="fps-display">{{ "%.1f"|format(status.actual_fps) }} FPS</span>
                </div>
                
                <div class="mb-3">
                    <strong>Frame Count:</strong><br>
                    <span id="frameCount">{{ status.frame_count }}</span>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-gauge-high"></i> Performance Snapshot</h6>
            </div>
            <div class="card-body small">
                <div class="text-uppercase text-muted fw-semibold mb-2">Animation Loop</div>
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                    <span>Target FPS</span>
                    <strong id="metricTargetFps">--</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                    <span>Actual FPS</span>
                    <strong id="metricActualFps">--</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                    <span>Target Frame</span>
                    <strong id="metricTargetFrame">--</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                    <span>Avg Generate</span>
                    <strong id="metricAvgGenerate">--</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                    <span>Avg Send</span>
                    <strong id="metricAvgSend">--</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                    <span>Avg Frame</span>
                    <strong id="metricAvgFrame">--</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                    <span>Last Frame</span>
                    <strong id="metricLastFrame">--</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                    <span>Inline Show</span>
                    <strong id="metricInlineShow">--</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Perf Samples</span>
                    <strong id="metricPerfSamples">--</strong>
                </div>

                <div class="text-uppercase text-muted fw-semibold mb-2">Driver</div>
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                    <span>Devices</span>
                    <strong id="metricDeviceCount">--</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                    <span>Frames Sent</span>
                    <strong id="metricDriverFrames">--</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                    <span>Bytes Sent</span>
                    <strong id="metricDriverBytes">--</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                    <span>Errors</span>
                    <strong id="metricDriverErrors">--</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                    <span>Avg Frame</span>
                    <strong id="metricDriverAvg">--</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                    <span>Last Frame</span>
                    <strong id="metricDriverLast">--</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>SPI Speed</span>
                    <strong id="metricSpiSpeed">--</strong>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h6>
            </div>
            <div class="card-body">
                <small>
                    <strong>Space:</strong> Stop animation<br>
                    <strong>R:</strong> Refresh plugins<br>
                    <strong>1-9:</strong> Quick select animation
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentAnimation = null;
let parameterUpdateTimeout = null;
let dpadCooldown = null;

function humanizeParamName(name) {
    return name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}

// Select and start animation
function selectAnimation(name) {
    currentAnimation = name;
    updateTetrisControls(name);
    
    // Update button states
    document.querySelectorAll('.animation-btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
    });
    
    document.querySelector(`[data-animation="${name}"]`).classList.remove('btn-outline-primary');
    document.querySelector(`[data-animation="${name}"]`).classList.add('btn-primary');
    
    // Start animation
    startAnimation(name).then(result => {
        if (result.success) {
            loadAnimationParameters(name);
        }
    });
}

// Load animation parameters
function loadAnimationParameters(name) {
    fetch(`/api/animations/${name}`)
        .then(r => r.json())
        .then(info => {
            if (info.parameters) {
                renderParameterControls(info.parameters, info.current_params);
                document.getElementById('parametersCard').style.display = 'block';
            }
        })
        .catch(console.error);
}

function updateTetrisControls(name) {
    const card = document.getElementById('tetrisControlsCard');
    if (!card) return;
    const isTetris = name && name.toLowerCase() === 'tetris';
    card.style.display = isTetris ? 'block' : 'none';
}

function sendDpad(direction) {
    return fetch(`/api/dpad/${direction}`, {method: 'POST'})
        .then(r => r.json())
        .catch(console.error);
}

// Render parameter controls
function renderParameterControls(schema, currentParams) {
    const container = document.getElementById('parametersContainer');
    container.innerHTML = '';
    
    Object.entries(schema).forEach(([paramName, paramInfo]) => {
        const currentValue = currentParams[paramName] || paramInfo.default;
        const prettyName = humanizeParamName(paramName);
        const rangeText = (paramInfo.min !== undefined && paramInfo.max !== undefined)
            ? `Range: ${paramInfo.min} ‚Äì ${paramInfo.max} (default ${paramInfo.default})`
            : `Default: ${paramInfo.default ?? '--'}`;
        
        const controlDiv = document.createElement('div');
        controlDiv.className = 'parameter-control';
        
        let controlHtml = `
            <label class="form-label">
                <strong>${prettyName}</strong>
                <small class="text-muted d-block">${paramInfo.description}</small>
                <small class="text-muted">${rangeText}</small>
            </label>
        `;
        
        if (paramInfo.type === 'float' || paramInfo.type === 'int') {
            const step = paramInfo.type === 'float' ? '0.1' : '1';
            controlHtml += `
                <div class="row">
                    <div class="col-8">
                        <input type="range" class="form-range" 
                               id="${paramName}" 
                               min="${paramInfo.min}" 
                               max="${paramInfo.max}" 
                               step="${step}"
                               value="${currentValue}"
                               oninput="updateParameter('${paramName}', this.value, '${paramInfo.type}')">
                    </div>
                    <div class="col-4">
                        <input type="number" class="form-control form-control-sm" 
                               value="${currentValue}"
                               min="${paramInfo.min}" 
                               max="${paramInfo.max}" 
                               step="${step}"
                               onchange="updateParameter('${paramName}', this.value, '${paramInfo.type}'); document.getElementById('${paramName}').value = this.value;">
                    </div>
                </div>
            `;
        } else if (paramInfo.type === 'bool') {
            controlHtml += `
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" 
                           id="${paramName}" 
                           ${currentValue ? 'checked' : ''}
                           onchange="updateParameter('${paramName}', this.checked, 'bool')">
                    <label class="form-check-label" for="${paramName}">Enable</label>
                </div>
            `;
        } else {
            controlHtml += `
                <input type="text" class="form-control" 
                       id="${paramName}" 
                       value="${currentValue}"
                       onchange="updateParameter('${paramName}', this.value, 'str')">
            `;
        }
        
        controlDiv.innerHTML = controlHtml;
        container.appendChild(controlDiv);
    });
}

// Update parameter with debouncing
function updateParameter(name, value, type) {
    // Convert value to appropriate type
    let convertedValue = value;
    if (type === 'int') {
        convertedValue = parseInt(value);
    } else if (type === 'float') {
        convertedValue = parseFloat(value);
    } else if (type === 'bool') {
        convertedValue = Boolean(value);
    }
    
    // Clear existing timeout
    if (parameterUpdateTimeout) {
        clearTimeout(parameterUpdateTimeout);
    }
    
    // Set new timeout for debounced update
    parameterUpdateTimeout = setTimeout(() => {
        const params = {};
        params[name] = convertedValue;
        
        updateParameters(params).then(result => {
            if (!result.success) {
                console.error('Failed to update parameter:', name);
            }
        });
    }, 100); // 100ms debounce
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT') return; // Don't interfere with input fields
    
    switch(e.key) {
        case ' ':
            e.preventDefault();
            stopAnimation();
            break;
        case 'r':
        case 'R':
            refreshPlugins();
            break;
        default:
            // Number keys 1-9 for quick animation selection
            const num = parseInt(e.key);
            if (num >= 1 && num <= 9) {
                const buttons = document.querySelectorAll('.animation-btn');
                if (buttons[num - 1]) {
                    buttons[num - 1].click();
                }
            }
    }
});

document.querySelectorAll('.dpad-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const direction = btn.getAttribute('data-direction');
        if (!direction) return;
        if (dpadCooldown) {
            clearTimeout(dpadCooldown);
        }
        sendDpad(direction);
        dpadCooldown = setTimeout(() => {
            dpadCooldown = null;
        }, 75);
    });
});

// Enhanced status updates
function updateStatus() {
    getStatus().then(status => {
        // Update status indicators
        const indicator = document.querySelector('.status-indicator');
        const statusText = document.querySelector('.status-text');
        const fpsDisplay = document.querySelector('.fps-display');
        const frameCount = document.getElementById('frameCount');
        
        if (indicator) {
            indicator.className = 'status-indicator ' + 
                (status.is_running ? 'status-running' : 'status-stopped');
        }
        
        if (statusText) {
            statusText.textContent = status.is_running ? 
                status.current_animation : 'None';
        }
        
        if (fpsDisplay) {
            fpsDisplay.textContent = `${status.actual_fps.toFixed(1)} FPS`;
        }
        
        if (frameCount) {
            frameCount.textContent = status.frame_count;
        }
        
        // Update current animation button state
        if (status.is_running && status.current_animation !== currentAnimation) {
            currentAnimation = status.current_animation;
            updateTetrisControls(currentAnimation);
            document.querySelectorAll('.animation-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            });
            
            const currentBtn = document.querySelector(`[data-animation="${currentAnimation}"]`);
            if (currentBtn) {
                currentBtn.classList.remove('btn-outline-primary');
                currentBtn.classList.add('btn-primary');
            }
        } else if (!status.is_running) {
            currentAnimation = null;
            updateTetrisControls(null);
        }
    }).catch(console.error);
}

// Start with current animation if running
{% if status.is_running %}
currentAnimation = '{{ status.current_animation }}';
updateTetrisControls(currentAnimation);
loadAnimationParameters(currentAnimation);
{% endif %}
</script>
{% endblock %}
